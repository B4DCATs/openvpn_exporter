version: '3.8'

services:
  openvpn-exporter:
    build: .
    container_name: openvpn-exporter-v2
    ports:
      - "9176:9176"
    volumes:
      # Mount OpenVPN status files (read-only)
      - /var/log/openvpn:/var/log/openvpn:ro
      - /etc/openvpn:/etc/openvpn:ro
      # Optional: Mount custom status files
      - ./examples:/app/examples:ro
    environment:
      - SECRET_KEY=${SECRET_KEY:-change-me-in-production}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - RATE_LIMIT_WINDOW=${RATE_LIMIT_WINDOW:-60}
      - MAX_REQUESTS_PER_WINDOW=${MAX_REQUESTS_PER_WINDOW:-100}
    command: >
      --openvpn.status_paths /var/log/openvpn/server.status,/var/log/openvpn/client.status
      --web.listen-address :9176
      --ignore.individuals
      --log-level INFO
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:9176/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - monitoring


networks:
  monitoring:
    driver: bridge
